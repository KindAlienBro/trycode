<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - AcharyaConnect</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
  <!-- Font Awesome for bell icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      color: #003366;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
    }

    .dashboard-container {
      margin: auto;
      background: #f0f8ff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .profile-actions {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center; /* Align items vertically */
      gap: 15px;
      z-index: 1000;
    }

    /* Bell Icon Styles */
    .notification-bell-btn {
        background-color: #ffa500;
        color: #003366;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        font-size: 20px; /* Adjusted for bell */
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: background 0.3s ease, color 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative; /* For badge positioning */
    }
    .notification-bell-btn:hover { background-color: #e89c00; }
    

    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: bold;
        display: none; /* Hidden by default */
    }
    .notification-badge.active { display: block; }


    .dark-toggle-btn {
      background-color: #ffa500; 
      color: #003366; 
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: background 0.3s ease, color 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dark-toggle-btn:hover { background-color: #e89c00; }
    

    .logout-btn {
      background-color: #ff4444;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .logout-btn:hover { background-color: #cc0000; }

    .profile-section { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
    .profile-section img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ffa500; }
    .profile-details h2 { font-size: 1.5rem; }
    .role-label { background-color: #007bff; color: #fff; padding: 3px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; display: inline-block; }

    .action-buttons { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; }
    .action-buttons button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .action-buttons button:hover { background-color: #0056b3; }
    .action-buttons button#createNotificationBtn { background-color: #fd7e14; } /* Orange for create notification */
    .action-buttons button#createNotificationBtn:hover { background-color: #e6690d; }


    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: #003366; padding: 20px; border-radius: 15px; text-align: center; color: white; }
    .stat-card h3 { font-size: 2rem; color: #ffa500; }

    .calendar-filters-container { 
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px; 
        margin-bottom: 20px;
    }
    .calendar-filters-container h3 { margin: 0; }
    .filter-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .calendar-filters-container select { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; font-family: 'Poppins'; min-width: 150px; background-color: #fff; color: #003366; }

    #calendar { background: white; color: black; border-radius: 15px; padding: 10px; margin-bottom: 20px; border: 1px solid #eee; }

    #taskForm, #createNotificationFormModal .modal-content-base div[style*="flex-direction: column"] { /* Grouped for common form styles, targeting the inner div for createNotification */
      background-color: #e9ecef; padding: 20px; border-radius: 15px; 
      margin-bottom: 30px; border: 1px solid #ced4da; 
    }
    #taskForm { display: none; } /* Keep taskForm hidden initially */

    #taskForm h3, #createNotificationFormModal .modal-content-base h3 { 
        color: #003366; border-bottom: 2px solid #007bff; padding-bottom: 10px; 
        margin-bottom: 20px;
    }
    #taskForm input, #taskForm select, #taskForm textarea,
    #createNotificationFormModal .modal-content-base input, 
    #createNotificationFormModal .modal-content-base select, 
    #createNotificationFormModal .modal-content-base textarea { 
        padding: 10px; border-radius: 10px; border: 1px solid #b1aeae; 
        font-family: 'Poppins'; width: 100%; margin-bottom: 10px; 
        background-color: #fff; color: #003366;
    }
    #taskForm button, #createNotificationFormModal .modal-content-base button { font-family: 'Poppins'; }

    .selected-assignees, .selected-notification-recipients { /* Common styling for chips */
        display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; 
        padding: 10px; background-color: #f8f9fa; border-radius: 10px; min-height: 50px; 
    }
    .assignee-box, .recipient-box { /* Common styling for individual chip */
        background-color: #ffffff; border: 2px solid #007bff; border-radius: 15px; 
        padding: 10px 15px; display: flex; align-items: center; gap: 10px; 
        position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        color: #003366; /* Ensure text color is set for chips */
    }
    .assignee-box img, .recipient-box img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .assignee-box .assignee-role, .recipient-box .recipient-role { font-size: 0.75rem; color: #6c757d; font-style: italic; }
    .assignee-box .remove-btn, .recipient-box .remove-btn { 
        background-color: #ff4d4d; border: none; border-radius: 50%; color: white; 
        width: 20px; height: 20px; font-size: 14px; cursor: pointer; 
        position: absolute; top: -5px; right: -5px; 
        display: flex; align-items: center; justify-content: center; 
    }


    /* Modal Base Styles (Task Details, View Tasks, Notifications, Create Notification) */
    .modal-base { 
        display: none; position: fixed; top: 0; left: 0; 
        width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); 
        z-index: 9999; justify-content: center; align-items: center; 
    }
    .modal-content-base { 
        background: white; padding: 30px; border-radius: 15px; 
        width: 90%; max-height: 80vh; overflow-y: auto; position: relative; 
        color: #003366; /* Default text color for modal content */
    }
    .modal-content-base h2 { color: #003366; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    
    /* Task Details Modal Specifics */
    #taskDetailsModal .modal-content-base { max-width: 600px; }
    #taskDetailsModal p { margin: 10px 0; line-height: 1.6; }
    #taskDetailsModal .task-info { margin-bottom: 20px; }
    #taskDetailsModal .status-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-left: 10px; font-size: 0.8em; }
    .status-pending { background-color: #ffc107; color: #000; }
    .status-completed { background-color: #28a745; color: #fff; }
    .status-overdue { background-color: #dc3545; color: #fff; }
    #taskDetailsModal .assignees-list { margin-top: 20px; }
    #taskDetailsModal .assignees-list h3 { margin-bottom: 10px; color: #003366; }
    #taskDetailsModal .assignee-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 10px; }
    #taskDetailsModal .assignee-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    #taskDetailsModal .assignee-item .assignee-role-modal { font-size: 0.8rem; color: #495057; background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }
    
    /* Shared Close Button Style for Modals */
    .close-modal-btn { 
        position: absolute; top: 15px; right: 15px; background: #ff4444; color: white; 
        border: none; border-radius: 50%; width: 30px; height: 30px; 
        font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-weight: bold;
    }
    /* Apply to all specific close buttons */
    #taskDetailsModal .close-modal-btn, /* Already styled, but ensure consistency */
    #viewTasksModal #closeViewTasksModalBtn,
    #notificationsModal #closeNotificationsModalBtn,
    #createNotificationFormModal #closeCreateNotificationModalBtn,
    #notificationDetailsModal #closeNotificationDetailsModalBtn { /* New one */
        /* Uses the .close-modal-btn class now */
    }


    #taskDetailsModal .action-buttons-container { display: flex; gap: 10px; margin-top: 20px; }
    #taskDetailsModal .action-btn { padding: 8px 15px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .edit-btn { background-color: #ffc107; color: #000; }
    .delete-btn { background-color: #dc3545; color: #fff; }
    .close-btn { background-color: #6c757d; color: #fff; } /* This is for the 'Close' button within task details, not the 'X' */
    
    /* View Tasks Modal Specifics */
    #viewTasksModal .modal-content-base { max-width: 800px; }
    #viewTasksModal .modal-content-base h3 { margin-bottom: 10px; }
    #viewTasksModal ul li {
        cursor:pointer; margin-bottom:8px; padding:5px; border:1px solid #eee; border-radius:5px;
        color: #003366; /* Default list item color */
    }


    /* Notifications List Modal Styles */
    #notificationsModal .modal-content-base { max-width: 500px; }
    .notification-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        background-color: #f9f9f9;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer; /* Make items look clickable */
    }
    .notification-item:hover { background-color: #f0f0f0; }
    .notification-item:last-child { border-bottom: none; }
    .notification-item.unread { background-color: #fff3cd; } /* Light yellow for unread */
    .notification-title { font-weight: 600; font-size: 1.1em; margin-bottom: 5px; color: #003366; }
    .notification-message-content { 
        font-size: 0.9em; margin-top: 5px; color: #444; 
        /* For list view, truncate long messages */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%; /* ensure it doesn't overflow its container */
    }
    .notification-from, .notification-timestamp { font-size: 0.85em; color: #555; }
    .notification-from { margin-bottom: 3px; }
    #noNotificationsMessage { text-align: center; color: #777; padding: 20px; }

    /* Notification Details Modal Specifics */
    #notificationDetailsModal .modal-content-base { max-width: 550px; z-index: 10000; /* Ensure it's on top if other modals are open */ }
    #notificationDetailsModal .notification-detail-body p { margin: 10px 0; line-height: 1.6; }
    #notificationDetailsModal .notification-detail-body strong { color: #003366; }
    #notificationDetailMessage { /* For full message display */
        white-space: pre-wrap; /* Respect newlines from textarea */
        word-wrap: break-word; /* Break long words */
        max-height: 300px; /* Limit height and allow scroll if needed */
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #eee;
    }


    /* Create Notification Modal (using taskForm styles for now) */
    #createNotificationFormModal .modal-content-base { max-width: 600px; background-color: #fff; /* Override grouped form style */ }
    #createNotificationFormModal #closeCreateNotificationModalBtn { z-index: 10; }


    .error-message { color: #dc3545; padding: 10px; background-color: #f8d7da; border-radius: 5px; margin-top: 10px; }
    .loading-message { color: #6c757d; font-style: italic; }

    /* --- DARK MODE STYLES --- */
    body.dark-mode {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    body.dark-mode .dashboard-container {
      background: #2c2c2c;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    body.dark-mode .profile-section img {
        border-color: #e89c00; 
    }
    body.dark-mode .profile-details h2, 
    body.dark-mode .profile-details p {
        color: #f0f0f0;
    }
    body.dark-mode .role-label {
        background-color: #0056b3; 
        color: #e0e0e0;
    }

    body.dark-mode .notification-bell-btn { background-color: #333; color: #ffa500; }
    body.dark-mode .notification-bell-btn:hover { background-color: #444; }
    body.dark-mode .dark-toggle-btn { background-color: #333; color: #ffa500; }
    body.dark-mode .dark-toggle-btn:hover { background-color: #444; }

    body.dark-mode .action-buttons button {
        background-color: #0056b3;
        color: #e0e0e0;
    }
    body.dark-mode .action-buttons button:hover {
        background-color: #004494;
    }
    body.dark-mode .action-buttons button#createNotificationBtn {
        background-color: #e6690d; 
    }
    body.dark-mode .action-buttons button#createNotificationBtn:hover {
        background-color: #c45a0b;
    }

    body.dark-mode .stat-card {
        background: #3a3a3a; /* Darker grey for stat cards */
        color: #f0f0f0;
    }
    body.dark-mode .stat-card h3 {
        color: #ffb733; 
    }
    
    body.dark-mode .calendar-filters-container h3 {
        color: #c0c0c0; 
    }
    body.dark-mode .calendar-filters-container select {
        background-color: #333;
        color: #fff;
        border: 1px solid #555;
    }

    body.dark-mode #calendar {
        background: #2c2c2c;
        color: #f0f0f0; 
        border: 1px solid #444;
    }
    body.dark-mode .fc .fc-col-header-cell-cushion, /* Day headers */
    body.dark-mode .fc .fc-daygrid-day-number, /* Day numbers */
    body.dark-mode .fc .fc-list-event-title a, /* List view event titles */
    body.dark-mode .fc .fc-list-day-text, /* List view day text */
    body.dark-mode .fc .fc-list-day-side-text, /* List view day side text */
    body.dark-mode .fc .fc-toolbar-title /* Calendar Title */ {
        color: #e0e0e0 !important; 
    }
    body.dark-mode .fc .fc-button { /* FC buttons like prev, next, today */
        background-color: #444;
        color: #f0f0f0;
        border-color: #555;
        box-shadow: none;
    }
     body.dark-mode .fc .fc-button-primary:not(:disabled).fc-button-active, 
     body.dark-mode .fc .fc-button-primary:not(:disabled):active { /* Active/Clicked FC buttons */
        background-color: #555;
        border-color: #666;
    }
    body.dark-mode .fc .fc-button:hover {
        background-color: #555;
    }
    body.dark-mode .fc-theme-standard td,
    body.dark-mode .fc-theme-standard th { /* Grid lines */
        border-color: #454d55;
    }
    body.dark-mode .fc-list-event:hover td { /* Hover on list items */
        background-color: #3a3a3a;
    }
    body.dark-mode .fc-daygrid-event .fc-event-title, /* dayGrid event titles */
    body.dark-mode .fc-timegrid-event .fc-event-title, /* timeGrid event titles */
    body.dark-mode .fc-list-event .fc-event-title /* list view event titles */ {
        color: #212529; /* Dark text on light event backgrounds */
    }
     body.dark-mode .fc-event.status-completed .fc-event-title, /* Example for specific status if needed */
     body.dark-mode .fc-event.status-overdue .fc-event-title {
        color: #fff; /* White text if event bg is dark green/red */
     }


    body.dark-mode .modal-content-base { background: #2d2d2d; color: #f0f0f0; }
    body.dark-mode .modal-content-base h2 { color: #58a6ff; border-bottom-color: #0056b3; } /* Lighter blue for heading */
    
    body.dark-mode #taskDetailsModal .assignee-item { background-color: #3d3d3d; color: #f0f0f0; }
    body.dark-mode #taskDetailsModal .assignee-item strong { color: #f0f0f0; }
    body.dark-mode #taskDetailsModal .assignee-item .assignee-role-modal { background-color: #555; color: #ddd; }
    body.dark-mode #taskDetailsModal .assignees-list h3 { color: #58a6ff; }
    
    body.dark-mode #viewTasksModal .modal-content-base h3[style*="green"] { color: #3fb950; }
    body.dark-mode #viewTasksModal .modal-content-base h3[style*="orange"] { color: #ffa500; }
    body.dark-mode #viewTasksModal .modal-content-base h3[style*="red"] { color: #f85149; }
    body.dark-mode #viewTasksModal ul li { color: #c9d1d9; border-color: #444; }

    body.dark-mode .notification-item { background-color: #3a3a3a; border-bottom-color: #444; }
    body.dark-mode .notification-item:hover { background-color: #484848; }
    body.dark-mode .notification-item.unread { background-color: #53450e; }
    body.dark-mode .notification-title { color: #58a6ff; } /* Lighter blue */
    body.dark-mode .notification-message-content { color: #bbb; }
    body.dark-mode .notification-from, body.dark-mode .notification-timestamp { color: #bbb; }
    body.dark-mode #noNotificationsMessage { color: #aaa; }

    body.dark-mode #notificationDetailsModal .notification-detail-body strong { color: #58a6ff; }
    body.dark-mode #notificationDetailMessage {
        background-color: #3a3a3a;
        border: 1px solid #555;
        color: #ddd;
    }


    body.dark-mode #taskForm, 
    body.dark-mode #createNotificationFormModal .modal-content-base div[style*="flex-direction: column"] { 
        background-color: #2a2a2a; border-color: #444; 
    }
    body.dark-mode #createNotificationFormModal .modal-content-base { background-color: #2d2d2d; /* Ensure modal bg is dark */ }


    body.dark-mode #taskForm h3, body.dark-mode #createNotificationFormModal .modal-content-base h3 { color: #58a6ff; border-bottom-color: #0056b3; }
    body.dark-mode #taskForm input, body.dark-mode #taskForm select, body.dark-mode #taskForm textarea,
    body.dark-mode #createNotificationFormModal .modal-content-base input, 
    body.dark-mode #createNotificationFormModal .modal-content-base select, 
    body.dark-mode #createNotificationFormModal .modal-content-base textarea { 
        background-color: #333; color: #fff; border: 1px solid #555; 
    }
    body.dark-mode #taskForm input::placeholder, body.dark-mode #taskForm textarea::placeholder,
    body.dark-mode #createNotificationFormModal .modal-content-base input::placeholder, 
    body.dark-mode #createNotificationFormModal .modal-content-base textarea::placeholder { color: #aaa; }
    
    body.dark-mode .selected-assignees, body.dark-mode .selected-notification-recipients { background-color: #383838; }
    body.dark-mode .assignee-box, body.dark-mode .recipient-box { background-color: #404040; border-color: #007bff; color: #fff; }
    body.dark-mode .assignee-box strong, body.dark-mode .recipient-box strong { color: #fff; }
    body.dark-mode .assignee-box .assignee-role, body.dark-mode .recipient-box .recipient-role { color: #bbb; }
    body.dark-mode .assignee-box div[style*="font-size:0.75rem"], 
    body.dark-mode .recipient-box div[style*="font-size:0.75rem"] { color: #aaa !important; } /* AUID color */


    @media (max-width: 768px) {
      .calendar-filters-container { flex-direction: column; align-items: flex-start; gap: 10px; }
      .filter-group { width: 100%; justify-content: space-between; }
      .filter-group select { flex-grow: 1; }
      .profile-actions { top: 10px; right: 10px; gap: 10px; }
      .logout-btn { padding: 8px 15px; font-size: 0.9rem; }
      .modal-content-base { width: 95%; padding: 20px 15px; } /* Responsive modal content */
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="profile-actions">
    <button id="notificationBellBtn" class="notification-bell-btn">
        <i class="fas fa-bell"></i>
        <span id="notificationBadge" class="notification-badge">0</span>
    </button>
    <button id="toggleDarkMode" class="dark-toggle-btn">🌙</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="dashboard-container">
    <div class="profile-section">
      <img id="admin-photo" src="default_admin.jpg" alt="Admin Profile Photo" />
      <div class="profile-details">
        <h2 id="admin-name">Loading...</h2>
        <p id="admin-auid">AUID: Loading...</p>
        <span class="role-label">ADMIN</span>
      </div>
    </div>

    <div class="action-buttons">
      <button id="viewTasksBtn">View Tasks</button>
      <button id="createAssignBtn">Create & Assign Task</button>
      <button id="createNotificationBtn">Create Notification</button>
    </div>

    <!-- Task Creation Form (Modal or inline block) -->
    <div id="taskForm"> <!-- display: none is now in CSS -->
      <h3>New Task</h3>
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <input type="text" id="taskTitle" placeholder="Task Title" />
        <textarea id="taskDescription" placeholder="Task Description" rows="4"></textarea>
        <input type="datetime-local" id="dueDateTime" />
        <select id="filterRoleForAssignee" style="margin-bottom: 5px;">
            <option value="all">Show All Roles (for Task)</option>
            <option value="Principal">Principals</option>
            <option value="HOD">HODs</option>
            <option value="Faculty">Faculty</option>
        </select>
        <select id="assigneeSelect">
          <option value="">Select Assignee(s) for Task</option>
        </select>
        <div class="selected-assignees" id="selectedAssignees"></div>
        <button type="button" id="submitTask" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-weight: 600;">Submit Task</button>
      </div>
    </div>

    <!-- Notification Creation Form (Modal or inline block) -->
    <div id="createNotificationFormModal" class="modal-base"> <!-- Initially hidden -->
        <div class="modal-content-base"> <!-- Removed style here, controlled by CSS -->
            <button id="closeCreateNotificationModalBtn" class="close-modal-btn">×</button>
            <h3>Create New Notification</h3>
            <!-- This inner div is targeted by grouped form styles for background in dark mode -->
            <div style="display: flex; flex-direction: column; gap: 15px; padding: 20px; border-radius: 10px; margin-top:10px;"> 
                <input type="text" id="notificationFormTitle" placeholder="Notification Title" />
                <textarea id="notificationFormMessage" placeholder="Notification Message" rows="4"></textarea>
                
                <label for="notificationRecipientType">Send To:</label>
                <select id="notificationRecipientType">
                    <option value="all_users">All Users</option>
                    <option value="all_principals">All Principals</option>
                    <option value="all_hods">All HODs</option>
                    <option value="all_faculty">All Faculty</option>
                    <option value="specific_users">Specific Users</option>
                </select>

                <div id="specificRecipientsSection" style="display:none;">
                    <label for="filterRoleForNotificationRecipient">Filter Recipients by Role:</label>
                    <select id="filterRoleForNotificationRecipient" style="margin-bottom: 5px;">
                        <option value="all">Show All Roles</option>
                        <option value="Principal">Principals</option>
                        <option value="HOD">HODs</option>
                        <option value="Faculty">Faculty</option>
                    </select>
                    <select id="notificationRecipientSelect">
                      <option value="">Select Specific Recipient(s)</option>
                    </select>
                    <div class="selected-notification-recipients" id="selectedNotificationRecipients"></div>
                </div>

                <button type="button" id="sendNotificationBtn" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-weight: 600;">Send Notification</button>
            </div>
        </div>
    </div>


    <div class="stats-grid" id="task-stats">
      <div class="stat-card"><h3>0</h3><p>Total Tasks</p></div>
      <div class="stat-card"><h3>0</h3><p>Completed</p></div>
      <div class="stat-card"><h3>0</h3><p>Pending</p></div>
      <div class="stat-card"><h3>0</h3><p>Overdue</p></div>
    </div>

    <div class="calendar-filters-container">
      <h3>Task Calendar</h3>
      <div class="filter-group">
        <select id="filterCalendarAssigneeRole">
          <option value="all_assignees">All Assignees</option>
          <option value="Principal">Principals</option>
          <option value="HOD">HODs</option>
          <option value="Faculty">Faculty</option>
        </select>
        <select id="filterCalendarTaskStatus">
          <option value="all">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="pending">Pending</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>
    </div>

    <div id="calendar"></div>
  </div>

  <!-- Task Details Modal -->
  <div id="taskDetailsModal" class="modal-base">
    <div class="modal-content-base">
      <button class="close-modal-btn" onclick="closeTaskDetailsModal()">×</button>
      <h2 id="taskModalTitle">Task Title</h2>
      <div class="task-info">
        <p><strong>Description:</strong> <span id="taskModalDescription"></span></p>
        <p><strong>Due Date:</strong> <span id="taskModalDueDate"></span></p>
        <p><strong>Status:</strong> 
          <span id="taskModalStatusText"></span>
          <span id="taskModalStatusBadge" class="status-badge"></span>
        </p>
        <p><strong>Created By:</strong> <span id="taskModalCreatedBy"></span></p>
      </div>
      <div class="assignees-list">
        <h3>Assigned To</h3>
        <div id="taskModalAssignees"></div>
      </div>
      <div class="action-buttons-container">
        <button class="action-btn edit-btn" id="editTaskBtn">Edit</button>
        <button class="action-btn delete-btn" id="deleteTaskBtn">Delete</button>
        <button class="action-btn close-btn" onclick="closeTaskDetailsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- View Tasks Modal -->
  <div id="viewTasksModal" class="modal-base">
    <div class="modal-content-base">
      <button id="closeViewTasksModalBtn" class="close-modal-btn">×</button>
      <h2 style="margin-bottom: 20px;">Task Overview</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
        <div>
          <h3 style="color: green;">✅ Completed</h3>
          <ul id="completedTasksList" style="list-style:none; padding-left:0;"></ul>
        </div>
        <div>
          <h3 style="color: orange;">🕒 Pending</h3>
          <ul id="pendingTasksList" style="list-style:none; padding-left:0;"></ul>
        </div>
        <div>
          <h3 style="color: red;">⛔ Overdue</h3>
          <ul id="overdueTasksList" style="list-style:none; padding-left:0;"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications List Modal -->
    <div id="notificationsModal" class="modal-base">
        <div class="modal-content-base">
            <button id="closeNotificationsModalBtn" class="close-modal-btn">×</button>
            <h2>Notifications</h2>
            <div id="notificationsListContainer">
                <!-- Notifications will be loaded here -->
                <p id="noNotificationsMessage" style="display:none;">No new notifications.</p>
            </div>
        </div>
    </div>

  <!-- Notification Details Modal -->
  <div id="notificationDetailsModal" class="modal-base">
    <div class="modal-content-base">
        <button id="closeNotificationDetailsModalBtn" class="close-modal-btn">×</button>
        <h2 id="notificationDetailTitle">Notification Details</h2>
        <div class="notification-detail-body">
            <p><strong>From:</strong> <span id="notificationDetailFrom"></span></p>
            <p><strong>Date:</strong> <span id="notificationDetailTimestamp"></span></p>
            <p><strong>Message:</strong></p>
            <p id="notificationDetailMessage"></p>
        </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    // --- Global Variables ---
    let calendar;
    let allTasks = []; 
    let currentSelectedTask = null; 
    const selectedAssignees = []; // For task assignment
    let MOCK_NOTIFICATIONS = [ // For admin to receive
        { id: 'notif1', title: "System Maintenance Scheduled", from: "IT Department", timestamp: new Date(Date.now() - 3600000 * 2).toISOString(), read: false, message: "System will be down for maintenance tonight from 2 AM to 4 AM.\nPlease ensure all work is saved prior to this window." },
        { id: 'notif2', title: "New Policy Update", from: "HR Department", timestamp: new Date(Date.now() - 3600000 * 5).toISOString(), read: true, message: "Please review the updated leave policy document on the portal.\nKey changes include...\n\nThank you." },
        { id: 'notif3', title: "Budget Submission Deadline Reminder", from: "Finance Office", timestamp: new Date(Date.now() - 3600000 * 24).toISOString(), read: false, message: "Reminder: All departmental budget submissions are due by EOD Friday. Late submissions will not be accepted." }
    ];
    let MOCK_SENT_NOTIFICATIONS = []; // For notifications admin sends
    const selectedNotificationRecipients = []; // For notification creation

    // --- Mock Data (Users, Tasks) ---
    const MOCK_ADMIN_INFO = { name: "Dr. Admin", auid: "ADM001", photo: "default_admin.jpg" };
    const MOCK_ASSIGNEES = [ /* Your existing MOCK_ASSIGNEES array */
        { auid: "PRN001", name: "Dr. Principal Smith", photo: "default_principal.jpg", role: "Principal" },
        { auid: "PRN002", name: "Ms. Principal Jones", photo: "default_principal.jpg", role: "Principal" },
        { auid: "HOD_CSE01", name: "Prof. HOD CompSci", photo: "default_hod.jpg", role: "HOD", department: "CSE" },
        { auid: "HOD_ECE01", name: "Prof. HOD Electronics", photo: "default_hod.jpg", role: "HOD", department: "ECE" },
        { auid: "FAC_CSE101", name: "Dr. Faculty Alice", photo: "default_faculty.jpg", role: "Faculty", department: "CSE" },
        { auid: "FAC_CSE102", name: "Mr. Faculty Bob", photo: "default_faculty.jpg", role: "Faculty", department: "CSE" },
        { auid: "FAC_ECE201", name: "Ms. Faculty Carol", photo: "default_faculty.jpg", role: "Faculty", department: "ECE" },
        { auid: "FAC_MECH01", name: "Mr. Faculty David", photo: "default_faculty.jpg", role: "Faculty", department: "MECH" }
    ];
    let MOCK_TASKS_DB = [ /* Your existing MOCK_TASKS_DB array */
         { id: 'task1', title: 'Review Annual Report', description: 'Final review of the annual college report.', due_date: '2024-08-15T10:00:00', assigned_to: ['PRN001'], status: 'pending', created_by: 'ADM001'},
         { id: 'task2', title: 'Organize Tech Fest', description: 'Plan and execute the inter-college tech fest.', due_date: '2024-09-30T17:00:00', assigned_to: ['HOD_CSE01', 'FAC_CSE101'], status: 'pending', created_by: 'ADM001'},
         { id: 'task3', title: 'Submit NBA Docs (ECE)', description: 'Compile/submit NBA docs for ECE.', due_date: '2024-07-20T23:59:00', assigned_to: ['HOD_ECE01'], status: 'pending', created_by: 'ADM001'},
         { id: 'task4', title: 'Faculty Performance Review', description: 'Conduct annual performance reviews for all faculty in CSE.', due_date: '2024-08-10T17:00:00', assigned_to: ['HOD_CSE01'], status: 'completed', created_by: 'ADM001'},
         { id: 'task5', title: 'Host Alumni Meet', description: 'Organize the annual alumni meet for ECE department.', due_date: '2024-07-01T17:00:00', assigned_to: ['HOD_ECE01', 'FAC_ECE201'], status: 'overdue', created_by: 'ADM001'},
    ];

    // --- Utility Functions ---
    function formatDateToDMY(dateString) { 
        if (!dateString) return 'Date not set';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid date';
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        } catch (e) { return 'Invalid date'; }
    }
    function formatNotificationTimestamp(isoString) {
        if (!isoString) return '';
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'Invalid Date'; // Handle invalid date strings
            return date.toLocaleString([], { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            console.error("Error formatting timestamp:", isoString, e);
            return 'Invalid Date';
        }
    }

    // --- Admin Info & Initial Data Loading ---
    function loadAdminInfo() { 
        const data = MOCK_ADMIN_INFO; 
        document.getElementById('admin-name').textContent = data.name;
        document.getElementById('admin-auid').textContent = 'AUID: ' + data.auid;
        document.getElementById('admin-photo').src = data.photo || 'default_admin.jpg';
    }

    // --- Task Management Functions ---
    function populateAssigneeSelectDropdown(roleFilter = 'all', selectElementId = 'assigneeSelect') {
      const assigneeSelect = document.getElementById(selectElementId);
      assigneeSelect.innerHTML = `<option value="">Select ${selectElementId === 'assigneeSelect' ? 'Assignee(s)' : 'Recipient(s)'}</option>`; 
      let filteredUsers = MOCK_ASSIGNEES;
      if (roleFilter !== 'all') {
        filteredUsers = MOCK_ASSIGNEES.filter(user => user.role === roleFilter);
      }
      filteredUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = JSON.stringify({ 
          auid: user.auid, name: user.name, photo: user.photo || 'default.jpg', role: user.role
        });
        option.textContent = `${user.name} (${user.role}) - ${user.auid}`;
        assigneeSelect.appendChild(option);
      });
    }
    async function loadAssigneeDetails(auids) { 
        if (!auids || auids.length === 0) return [];
        return new Promise(resolve => {
            setTimeout(() => { 
                const userDetails = auids.map(auid => MOCK_ASSIGNEES.find(u => u.auid === auid) || { auid, name: 'Unknown User', photo: 'default.jpg', role: 'Unknown' });
                resolve(userDetails.map(u => ({...u, photo: u.photo || 'default.jpg'})));
            }, 100); 
        });
    }
    async function showTaskDetailsModal(task) { 
        currentSelectedTask = task;
        const modal = document.getElementById('taskDetailsModal');
        modal.style.display = 'flex';
        document.getElementById('taskModalTitle').textContent = task.title || 'No title';
        document.getElementById('taskModalDescription').textContent = task.description || 'No description';
        document.getElementById('taskModalDueDate').textContent = formatDateToDMY(task.due_date || task.start); 
        document.getElementById('taskModalCreatedBy').textContent = task.created_by_name || MOCK_ASSIGNEES.find(u => u.auid === task.created_by)?.name || task.created_by || 'Unknown'; 
        const status = task.status || 'pending';
        document.getElementById('taskModalStatusText').textContent = status.charAt(0).toUpperCase() + status.slice(1);
        const statusBadge = document.getElementById('taskModalStatusBadge');
        statusBadge.className = 'status-badge'; 
        statusBadge.classList.add(`status-${status}`);
        statusBadge.textContent = status.toUpperCase();
        const assigneesContainer = document.getElementById('taskModalAssignees');
        assigneesContainer.innerHTML = '<p class="loading-message">Loading assignee details...</p>';
        const assignedToAUIDs = task.assigned_to || [];
        if (assignedToAUIDs.length > 0) {
            try {
                const assignees = await loadAssigneeDetails(assignedToAUIDs);
                assigneesContainer.innerHTML = ''; 
                if (assignees.length === 0) {
                    assigneesContainer.innerHTML = `<div class="error-message">No details found.</div><p>AUIDs: ${assignedToAUIDs.join(', ')}</p>`;
                } else {
                    assignees.forEach(user => {
                        assigneesContainer.innerHTML += `
                            <div class="assignee-item">
                                <img src="${user.photo || 'default.jpg'}" alt="${user.name || 'Assignee'}">
                                <div><strong>${user.name || 'N/A'}</strong><div>${user.auid || 'N/A'}</div><span class="assignee-role-modal">${user.role || 'N/A'}</span></div>
                            </div>`;
                    });
                }
            } catch (error) {
                assigneesContainer.innerHTML = `<div class="error-message">Error loading details.</div><p>AUIDs: ${assignedToAUIDs.join(', ')}</p>`;
            }
        } else {
            assigneesContainer.innerHTML = '<p>No one assigned.</p>';
        }
    }
    function closeTaskDetailsModal() { document.getElementById('taskDetailsModal').style.display = 'none'; currentSelectedTask = null; }
    function initializeCalendar() { 
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            height: 'auto', // Adjusted for better responsiveness
            eventClick: function(info) { showTaskDetailsModal({ ...info.event.extendedProps, id: info.event.id, title: info.event.title, due_date: info.event.startStr }); },
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: true }, events: [] 
        });
        calendar.render();
    }
    function loadTasksFromDatabase() { 
        const tasksFromDB = JSON.parse(JSON.stringify(MOCK_TASKS_DB)); 
        allTasks = tasksFromDB.map(task => {
            const dueDate = new Date(task.due_date); const today = new Date(); today.setHours(0,0,0,0); 
            let effectiveStatus = task.status;
            if (task.status !== 'completed' && dueDate < today) effectiveStatus = 'overdue';
            
            let color;
            let className = `status-${effectiveStatus}`; // Add status class for more specific styling
            switch(effectiveStatus) {
                case 'completed': color = '#28a745'; break; 
                case 'overdue': color = '#dc3545'; break; 
                default: color = '#ffc107'; break; // pending
            }
            return { 
                id: task.id, 
                title: task.title, 
                start: task.due_date, 
                allDay: task.due_date.length === 10, // Assume YYYY-MM-DD is all day
                color: color,
                classNames: [className], // Add class for specific event styling
                extendedProps: { 
                    description: task.description, 
                    status: effectiveStatus, 
                    assigned_to: task.assigned_to, 
                    created_by: task.created_by 
                }
            };
        });
        filterCalendarEvents(); 
    }
    function updateTaskStats() { 
        const total = allTasks.length;
        const completed = allTasks.filter(t => t.extendedProps.status === 'completed').length;
        const pending = allTasks.filter(t => t.extendedProps.status === 'pending').length; 
        const overdue = allTasks.filter(t => t.extendedProps.status === 'overdue').length;
        
        $('#task-stats').html(
            `<div class="stat-card"><h3>${total}</h3><p>Total Tasks</p></div>` +
            `<div class="stat-card"><h3>${completed}</h3><p>Completed</p></div>` +
            `<div class="stat-card"><h3>${pending}</h3><p>Pending</p></div>` +
            `<div class="stat-card"><h3>${overdue}</h3><p>Overdue</p></div>`
        );
    }

    // --- Notification Functions ---
    function updateNotificationBadge() {
        const badge = document.getElementById('notificationBadge');
        if (!badge) {
            console.error("Notification badge element (#notificationBadge) not found!");
            return;
        }
        if (!Array.isArray(MOCK_NOTIFICATIONS)) {
            console.error("MOCK_NOTIFICATIONS is not an array. Cannot update badge.");
            badge.textContent = '0';
            badge.classList.remove('active');
            return;
        }
        const unreadCount = MOCK_NOTIFICATIONS.filter(n => n && !n.read).length;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.add('active');
        } else {
            badge.textContent = '0'; 
            badge.classList.remove('active');
        }
    }

    function showNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
        if (!modal) {
            console.error("Notifications modal element (#notificationsModal) not found!");
            return; 
        }

        const listContainer = document.getElementById('notificationsListContainer');
        if (!listContainer) {
            console.error("Notifications list container element (#notificationsListContainer) not found!");
            modal.style.display = 'flex';
            return;
        }
        listContainer.innerHTML = ''; 

        const noNotificationsMsgEl = document.getElementById('noNotificationsMessage');
        if (!noNotificationsMsgEl) {
            console.warn("No notifications message element (#noNotificationsMessage) not found, but proceeding.");
        }

        if (!Array.isArray(MOCK_NOTIFICATIONS) || MOCK_NOTIFICATIONS.length === 0) {
            if (noNotificationsMsgEl) noNotificationsMsgEl.style.display = 'block';
            if (!Array.isArray(MOCK_NOTIFICATIONS)) console.error("MOCK_NOTIFICATIONS is not an array!");
        } else {
            if (noNotificationsMsgEl) noNotificationsMsgEl.style.display = 'none';
            try {
                MOCK_NOTIFICATIONS.sort((a, b) => {
                    const dateA = a && a.timestamp ? new Date(a.timestamp) : new Date(0);
                    const dateB = b && b.timestamp ? new Date(b.timestamp) : new Date(0);
                    if (isNaN(dateA.getTime())) return 1; 
                    if (isNaN(dateB.getTime())) return -1;
                    return dateB - dateA;
                }).forEach(notif => {
                    if (!notif || typeof notif !== 'object') { 
                        console.warn("Skipping invalid notification object in MOCK_NOTIFICATIONS:", notif);
                        return; 
                    }
                    const item = document.createElement('div');
                    item.className = 'notification-item' + (notif.read ? '' : ' unread');
                    item.setAttribute('data-notification-id', notif.id); // Store ID
                    item.innerHTML = `
                        <div class="notification-title">${notif.title || 'No Title'}</div>
                        <div class="notification-from">From: ${notif.from || 'Unknown Sender'}</div>
                        <div class="notification-message-content">${notif.message || ''}</div>
                        <div class="notification-timestamp">${formatNotificationTimestamp(notif.timestamp)}</div>
                    `;
                    item.addEventListener('click', function() {
                        showNotificationDetails(this.getAttribute('data-notification-id'));
                    });
                    listContainer.appendChild(item);
                });
            } catch (error) {
                console.error("Error processing and displaying notifications:", error);
                listContainer.innerHTML = '<p class="error-message">Error displaying notifications. Please check console.</p>';
            }
        }
        
        modal.style.display = 'flex';

        // Do NOT mark all as read here anymore. Mark as read when individual item is clicked.
        // Or, if you want to mark all as read when modal opens, re-add:
        // if (Array.isArray(MOCK_NOTIFICATIONS)) {
        //     MOCK_NOTIFICATIONS.forEach(n => { if (n && typeof n === 'object') { n.read = true; } });
        // }
        // updateNotificationBadge(); 
    }

    function closeNotificationsModal() { 
        const modal = document.getElementById('notificationsModal');
        if (modal) {
            modal.style.display = 'none'; 
        } else {
            console.error("Attempted to close notifications modal, but #notificationsModal not found.");
        }
    }

    function showNotificationDetails(notificationId) {
        const notification = MOCK_NOTIFICATIONS.find(n => n.id === notificationId);
        if (!notification) {
            console.error("Notification not found for ID:", notificationId);
            alert("Could not load notification details.");
            return;
        }

        document.getElementById('notificationDetailTitle').textContent = notification.title || "Notification Details";
        document.getElementById('notificationDetailFrom').textContent = notification.from || "N/A";
        document.getElementById('notificationDetailTimestamp').textContent = formatNotificationTimestamp(notification.timestamp);
        document.getElementById('notificationDetailMessage').textContent = notification.message || "No message content.";

        // Mark as read
        if (!notification.read) {
            notification.read = true;
            updateNotificationBadge();

            // Update the item in the list visually if the list modal is still open
            const listModal = document.getElementById('notificationsModal');
            if (listModal && listModal.style.display === 'flex') {
                const listItem = listModal.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
                if (listItem) {
                    listItem.classList.remove('unread');
                }
            }
        }
        
        // Optional: Close the main notifications list modal
        // closeNotificationsModal(); 

        document.getElementById('notificationDetailsModal').style.display = 'flex';
    }

    function closeNotificationDetailsModal() {
        const modal = document.getElementById('notificationDetailsModal');
        if (modal) {
            modal.style.display = 'none';
        } else {
            console.error("Attempted to close notification details modal, but #notificationDetailsModal not found.");
        }
    }


    function showCreateNotificationModal() {
        document.getElementById('createNotificationFormModal').style.display = 'flex';
        document.getElementById('notificationFormTitle').value = '';
        document.getElementById('notificationFormMessage').value = '';
        document.getElementById('notificationRecipientType').value = 'all_users';
        document.getElementById('specificRecipientsSection').style.display = 'none';
        document.getElementById('filterRoleForNotificationRecipient').value = 'all';
        populateAssigneeSelectDropdown('all', 'notificationRecipientSelect');
        selectedNotificationRecipients.length = 0;
        document.getElementById('selectedNotificationRecipients').innerHTML = '';
    }
    function closeCreateNotificationModal() { document.getElementById('createNotificationFormModal').style.display = 'none'; }

    function handleSendNotification() {
        const title = document.getElementById('notificationFormTitle').value.trim();
        const message = document.getElementById('notificationFormMessage').value.trim();
        const recipientType = document.getElementById('notificationRecipientType').value;

        if (!title || !message) {
            alert("Please enter a title and message for the notification.");
            return;
        }

        let recipients = [];
        if (recipientType === 'specific_users') {
            if (selectedNotificationRecipients.length === 0) {
                alert("Please select specific recipients or choose a group.");
                return;
            }
            recipients = selectedNotificationRecipients.map(r => r.auid);
        } else {
            recipients.push(recipientType); 
        }

        const newNotification = {
            id: 'sent_notif_' + Date.now(),
            title: title,
            message: message,
            from: MOCK_ADMIN_INFO.name + " (Admin)",
            timestamp: new Date().toISOString(),
            recipients: recipients, 
            senderAuid: MOCK_ADMIN_INFO.auid,
            read: false // New notifications you send (to others) are initially unread for them.
                       // For the admin's own view, it's debatable. Let's add it as unread to test.
        };

        MOCK_SENT_NOTIFICATIONS.push(newNotification);
        console.log("Notification Sent (Mock):", newNotification);
        
        // Add to admin's received list as well for immediate feedback in bell icon
        MOCK_NOTIFICATIONS.unshift({ 
            id: 'self_sent_' + newNotification.id, 
            title: `(Sent by You) ${newNotification.title}`, 
            from: "Yourself", 
            timestamp: newNotification.timestamp, 
            message: newNotification.message,
            read: false // Treat it as a new notification for the admin too
        });
        updateNotificationBadge();

        alert("Notification sent successfully (mock)!");
        closeCreateNotificationModal();
    }


    // --- Event Listeners Setup ---
    function setupEventListeners() {
      document.getElementById('createAssignBtn').addEventListener('click', () => { 
          const form = document.getElementById('taskForm'); form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
          if (form.style.display === 'block') { 
              document.getElementById('taskTitle').value = ''; document.getElementById('taskDescription').value = '';
              document.getElementById('dueDateTime').value = ''; document.getElementById('filterRoleForAssignee').value = 'all'; 
              populateAssigneeSelectDropdown('all', 'assigneeSelect'); selectedAssignees.length = 0; 
              document.getElementById('selectedAssignees').innerHTML = ''; 
          }
      });
      document.getElementById('filterRoleForAssignee').addEventListener('change', (e) => { 
          populateAssigneeSelectDropdown(e.target.value, 'assigneeSelect'); selectedAssignees.length = 0;
          document.getElementById('selectedAssignees').innerHTML = '';
      });
      document.getElementById('assigneeSelect').addEventListener('change', (e) => { 
            if (!e.target.value) return; 
            const selectedUserData = JSON.parse(e.target.value);
            if (selectedAssignees.find(user => user.auid === selectedUserData.auid)) {
                alert(`${selectedUserData.name} is already added.`); e.target.selectedIndex = 0; return;
            }
            selectedAssignees.push(selectedUserData);
            const container = document.getElementById('selectedAssignees');
            container.innerHTML += `
                <div class="assignee-box" data-auid="${selectedUserData.auid}">
                    <img src="${selectedUserData.photo}" alt="${selectedUserData.name}">
                    <div><strong>${selectedUserData.name}</strong><div class="assignee-role">${selectedUserData.role}</div><div style="font-size:0.75rem;color:#6c757d;">${selectedUserData.auid}</div></div>
                    <button type="button" class="remove-btn">×</button>
                </div>`;
            container.querySelector(`.assignee-box[data-auid="${selectedUserData.auid}"] .remove-btn`).addEventListener('click', function() {
                this.parentElement.remove();
                const index = selectedAssignees.findIndex(user => user.auid === selectedUserData.auid);
                if (index > -1) selectedAssignees.splice(index, 1);
            });
            e.target.selectedIndex = 0; 
      });
      document.getElementById('submitTask').addEventListener('click', () => { 
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDateTime = document.getElementById('dueDateTime').value;
            if (!title || !description || !dueDateTime || selectedAssignees.length === 0) {
                alert("Please fill all fields and select assignees."); return;
            }
            const assignedToAUIDs = selectedAssignees.map(user => user.auid);
            const dueDate = new Date(dueDateTime); const today = new Date(); today.setHours(0,0,0,0); 
            let status = 'pending'; if (dueDate < today && status !== 'completed') status = 'overdue'; 
            MOCK_TASKS_DB.push({ id: 'task' + Date.now(), title, description, due_date: dueDateTime, assigned_to: assignedToAUIDs, status, created_by: MOCK_ADMIN_INFO.auid }); 
            alert('Task created (mock)!'); document.getElementById('taskForm').style.display = 'none'; 
            loadTasksFromDatabase(); updateTaskStats(); 
      });

      document.getElementById('viewTasksBtn').addEventListener('click', () => { 
          document.getElementById('viewTasksModal').style.display = 'flex';
          const lists = { completed: 'completedTasksList', pending: 'pendingTasksList', overdue: 'overdueTasksList' };
          Object.values(lists).forEach(id => document.getElementById(id).innerHTML = ''); 
          
          allTasks.forEach(task => {
              const li = document.createElement('li');
              li.innerHTML = `${task.title || 'N/A'} - <small>Due: ${formatDateToDMY(task.start)}</small>`;
              
              if(document.body.classList.contains('dark-mode')) { } else { }

              li.onclick = () => { 
                  const fullTask = allTasks.find(t => t.id === task.id);
                  if(fullTask) {
                     const taskForModal = {
                         ...fullTask.extendedProps, 
                         id: fullTask.id,
                         title: fullTask.title,
                         due_date: fullTask.start 
                     };
                     showTaskDetailsModal(taskForModal);
                  }
                  document.getElementById('viewTasksModal').style.display = 'none'; 
              };
              const status = task.extendedProps.status || 'pending';
              if (lists[status]) {
                document.getElementById(lists[status]).appendChild(li);
              }
          });
      });
      document.getElementById('closeViewTasksModalBtn').addEventListener('click', () => { document.getElementById('viewTasksModal').style.display = 'none'; });

      const darkModeButton = document.getElementById('toggleDarkMode'); 
      darkModeButton.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        darkModeButton.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        if (calendar) { calendar.render(); } 
      });
      if (localStorage.getItem('theme') === 'dark') { 
          document.body.classList.add('dark-mode'); 
          darkModeButton.textContent = '☀️'; 
      } else { 
          darkModeButton.textContent = '🌙'; 
      }

      document.getElementById('filterCalendarTaskStatus').addEventListener('change', filterCalendarEvents);
      document.getElementById('filterCalendarAssigneeRole').addEventListener('change', filterCalendarEvents); 

      document.getElementById('editTaskBtn').addEventListener('click', () => { if (currentSelectedTask) alert('Edit for task ID: ' + currentSelectedTask.id + '. (Not implemented).'); });
      document.getElementById('deleteTaskBtn').addEventListener('click', () => { 
          if (!currentSelectedTask || !currentSelectedTask.id) return;
          if (confirm(`Delete task: "${currentSelectedTask.title}"?`)) {
              const index = MOCK_TASKS_DB.findIndex(t => t.id === currentSelectedTask.id);
              if (index > -1) { 
                  MOCK_TASKS_DB.splice(index, 1); 
                  alert('Task deleted (mock)'); 
                  closeTaskDetailsModal(); 
                  loadTasksFromDatabase(); 
                  updateTaskStats(); 
              } else { alert('Failed to delete: Not found (mock)'); }
          }
      });

      // Notification Event Listeners
      document.getElementById('notificationBellBtn').addEventListener('click', showNotificationsModal);
      document.getElementById('closeNotificationsModalBtn').addEventListener('click', closeNotificationsModal);
      document.getElementById('closeNotificationDetailsModalBtn').addEventListener('click', closeNotificationDetailsModal); // New
      document.getElementById('createNotificationBtn').addEventListener('click', showCreateNotificationModal);
      document.getElementById('closeCreateNotificationModalBtn').addEventListener('click', closeCreateNotificationModal);
      document.getElementById('sendNotificationBtn').addEventListener('click', handleSendNotification);
      
      document.getElementById('notificationRecipientType').addEventListener('change', function() {
          const specificSection = document.getElementById('specificRecipientsSection');
          specificSection.style.display = this.value === 'specific_users' ? 'block' : 'none';
          if(this.value === 'specific_users'){
              document.getElementById('filterRoleForNotificationRecipient').value = 'all';
              populateAssigneeSelectDropdown('all', 'notificationRecipientSelect');
          }
          selectedNotificationRecipients.length = 0;
          document.getElementById('selectedNotificationRecipients').innerHTML = '';
      });

      document.getElementById('filterRoleForNotificationRecipient').addEventListener('change', (e) => {
          populateAssigneeSelectDropdown(e.target.value, 'notificationRecipientSelect');
          selectedNotificationRecipients.length = 0;
          document.getElementById('selectedNotificationRecipients').innerHTML = '';
      });

      document.getElementById('notificationRecipientSelect').addEventListener('change', (e) => {
            if (!e.target.value) return; 
            const selectedUserData = JSON.parse(e.target.value);
            if (selectedNotificationRecipients.find(user => user.auid === selectedUserData.auid)) {
                alert(`${selectedUserData.name} is already added as a recipient.`); e.target.selectedIndex = 0; return;
            }
            selectedNotificationRecipients.push(selectedUserData);
            const container = document.getElementById('selectedNotificationRecipients');
            container.innerHTML += `
                <div class="recipient-box" data-auid="${selectedUserData.auid}">
                    <img src="${selectedUserData.photo}" alt="${selectedUserData.name}">
                    <div><strong>${selectedUserData.name}</strong><div class="recipient-role">${selectedUserData.role}</div><div style="font-size:0.75rem;color:#6c757d;">${selectedUserData.auid}</div></div>
                    <button type="button" class="remove-btn">×</button>
                </div>`;
            container.querySelector(`.recipient-box[data-auid="${selectedUserData.auid}"] .remove-btn`).addEventListener('click', function() {
                this.parentElement.remove();
                const index = selectedNotificationRecipients.findIndex(user => user.auid === selectedUserData.auid);
                if (index > -1) selectedNotificationRecipients.splice(index, 1);
            });
            e.target.selectedIndex = 0; 
      });
    }
    
    function filterCalendarEvents() { 
        const statusFilter = document.getElementById('filterCalendarTaskStatus').value;
        const roleFilter = document.getElementById('filterCalendarAssigneeRole').value; 
        
        if (!calendar) return; 
        calendar.removeAllEvents(); 
        
        let filteredTasksToShow = allTasks;
        if (statusFilter !== 'all') {
            filteredTasksToShow = filteredTasksToShow.filter(task => task.extendedProps.status === statusFilter);
        }
        if (roleFilter !== 'all_assignees') {
            filteredTasksToShow = filteredTasksToShow.filter(task => 
                task.extendedProps.assigned_to?.some(auid => MOCK_ASSIGNEES.find(a => a.auid === auid)?.role === roleFilter)
            );
        }
        calendar.addEventSource(filteredTasksToShow); 
    }

    function logout() { if (confirm('Are you sure you want to logout?')) alert("Logout successful (mock)!"); }

    // --- DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function() {
      loadAdminInfo();
      populateAssigneeSelectDropdown('all', 'assigneeSelect'); 
      initializeCalendar();
      setupEventListeners();
      loadTasksFromDatabase(); 
      updateTaskStats();  
      updateNotificationBadge(); 

      if (localStorage.getItem('theme') === 'dark') {
        if (calendar) { calendar.render(); }
      }
    });
  </script>

</body>
</html>